name: CI_RDP+APP

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: ğŸ“¥ Download Ngrok
      run: Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip

    - name: ğŸ—œï¸ Extract Ngrok
      run: Expand-Archive ngrok.zip -DestinationPath ngrok

    - name: ğŸ” Set Ngrok AuthToken
      run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: ğŸ–¥ï¸ Enable RDP and Firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: ğŸ”‘ Set Runner Admin Password
      run: Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "Adminrdp123" -Force)

    - name: ğŸšª Start Ngrok Tunnel
      run: Start-Process PowerShell -ArgumentList '-NoExit', '-Command', '.\ngrok\ngrok.exe tcp --region=ap 3389'

    - name: â³ Wait for Tunnel
      run: Start-Sleep -Seconds 10

    - name: ğŸ” Get Ngrok RDP Address
      run: |
        $maxAttempts = 5
        for ($i = 0; $i -lt $maxAttempts; $i++) {
          try {
            $response = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels
            $tcpTunnel = $response.tunnels | Where-Object { $_.proto -eq "tcp" }
            if ($tcpTunnel) {
              Write-Output "âœ… RDP Endpoint: $($tcpTunnel.public_url)"
              Write-Output "ğŸ‘¤ Username: runneradmin"
              Write-Output "ğŸ”‘ Password: Adminrdp123"
              exit 0
            }
          } catch {
            Start-Sleep -Seconds 3
          }
        }
        Write-Error "Ngrok tunnel did not start in time."

    - name: ğŸ“¥ Download ExpressVPN installer
      run: Invoke-WebRequest -Uri "https://www.expressvpn.com/clients/windows/expressvpn_windows_12.101.0.45_release.exe" -OutFile "expressvpn_installer.exe"

    - name: ğŸ•’ Try to install ExpressVPN (timeout 2 minutes)
      run: |
        $startTime = Get-Date
        Start-Process -FilePath "expressvpn_installer.exe" -ArgumentList '/quiet', '/norestart' -PassThru | Out-Null
        while ((Get-Date) - $startTime -lt (New-TimeSpan -Minutes 2)) {
          Start-Sleep -Seconds 5
          # Check if expressvpn.exe exists and responds
          if (Test-Path "C:\Program Files (x86)\ExpressVPN\expressvpn.exe") {
            try {
              & "C:\Program Files (x86)\ExpressVPN\expressvpn.exe" version | Out-Null
              Write-Output "âœ… ExpressVPN installed successfully."
              exit 0
            } catch {
              # Not ready yet, keep waiting
            }
          }
        }
        Write-Output "âš ï¸ ExpressVPN install timed out after 2 minutes. Skipping install."

    - name: ğŸ” Activate ExpressVPN CLI (skip if not installed)
      run: |
        if (Test-Path "C:\Program Files (x86)\ExpressVPN\expressvpn.exe") {
          & "C:\Program Files (x86)\ExpressVPN\expressvpn.exe" activate $Env:EXPRESSVPN_ACTIVATION_CODE
        } else {
          Write-Output "ExpressVPN not installed, skipping activation."
        }
      env:
        EXPRESSVPN_ACTIVATION_CODE: ${{ secrets.EXPRESSVPN_ACTIVATION_CODE }}

    - name: ğŸŒ Connect to Cambodia ExpressVPN server (skip if not installed)
      run: |
        if (Test-Path "C:\Program Files (x86)\ExpressVPN\expressvpn-ui\ExpressVPN.exe") {
          & "C:\Program Files (x86)\ExpressVPN\expressvpn-ui\ExpressVPN.exe" connect Cambodia
        } else {
          Write-Output "ExpressVPN not installed, skipping connection."
        }

    - name: ğŸ” Check ExpressVPN status (optional)
      run: |
        if (Test-Path "C:\Program Files (x86)\ExpressVPN\expressvpn-ui\ExpressVPN.exe") {
          & "C:\Program Files (x86)\ExpressVPN\expressvpn-ui\ExpressVPN.exe" status
        }

    - name: ğŸ”½ Download Your App
      run: Invoke-WebRequest -Uri "https://secuhex.com/app.zip" -OutFile app.zip

    - name: ğŸ—œï¸ Extract App
      run: Expand-Archive app.zip -DestinationPath app

    - name: ğŸš€ Run telegram_land_checker.exe
      run: |
        Start-Process -FilePath "telegram_land_checker.exe" -WorkingDirectory "${{ github.workspace }}\app"

    - name: ğŸ•’ Keep Runner Alive
      run: |
        for ($i = 0; $i -lt 358; $i++) {
          Write-Output "ğŸƒ Staying alive... $i minutes"
          Start-Sleep -Seconds 60
        }

    - name: ğŸ” Auto-Restart Workflow
      if: always()
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        if ("${{ job.status }}" -eq "cancelled") {
          Write-Output "ğŸš« Workflow was cancelled manually. Not restarting."
          exit 0
        }

        $headers = @{ Authorization = "Bearer $Env:GH_PAT" }
        $body = @{ ref = "${{ github.ref }}" } | ConvertTo-Json
        Invoke-RestMethod `
          -Uri "https://api.github.com/repos/${{ github.repository }}/actions/workflows/main.yml/dispatches" `
          -Method POST -Headers $headers -Body $body -ContentType "application/json"
        Write-Output "ğŸ” Re-triggered workflow run."
